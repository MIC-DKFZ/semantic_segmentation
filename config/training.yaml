# @package _global_

###### Main Config File for Training ######
# This config shows an overview about all parameters and there default values
# BEST PRACTICE - DO NOT CHANGE STUFF HERE - instead overwrite arguments from the commandline or
#             create a .yaml file in experiments and overwrite the settings you want to change

###### Hydra's Default List ######
defaults:
  - _self_
  # DATAHANDLING
  - img_loader: RGB                       # How to load the image files
  - label_handler: semantic_segmentation  # How to load and handle the labels
  - dataset: Cityscapes                   # Which Dataset to use
  - training_scheme: TrainVal             # How to use the data for training
  # MODEL SELECTION
  - model: hrnet                          # Which Model to use
  # TRAINING BEHAVIOUR
  - trainer: SemSeg                       # Behaviour during the training loop
  # ADDITIONAL TRAINING SETTING
  - metric: mean_IoU                      # Which Metric to use
  - optimizer: SGD                        # Which optimizer to use
  - lr_scheduler: polynomial              # Which learning rate scheduler to use
  - augmentation@augmentation.train: norm # Augmentations used for training
  - augmentation@augmentation.val: norm   # Augmentations used for validation
  - augmentation@augmentation.test: norm  # Augmentations used for testing/inference
  # FURTHER SETTINGS
  - callbacks: default                    # Which Callbacks should be used
  - logger: tensorboard                   # Which Logger to use
  # OVERWRITE AND REDEFINE SETTINGS IN EXPERIMENT OR ENVIRONMENT
  - optional experiment:
  - optional environment: local
  # HYDRA'S COLOLOG PLUGIN FOR LOGGING
  - override hydra/hydra_logging: colorlog
  - override hydra/job_logging: colorlog

###### Hyperparameters ######
compile: False                # If torch.compile should be used
num_workers: 10               # Number of workers for dataloader
lr: 0.01                      # Learning Rate
batch_size: 6                 # Batch size used for training
val_batch_size: ${batch_size}     # Batch size used for validation/testing
test_batch_size: ${batch_size}     # Batch size used for validation/testing
epochs: 400                   # Number of Epochs
momentum: 0.9                 # Momentune for SGD optimizer
weight_decay: 0.0005          # Weight Decay for SGD optimizer
fold:                         # Fold for Cross Validation, always needs to be in config for logging - can be empty

###### Loss Function ######
loss:
  function: [ CE, CE, CE, CE]     # List of lossfunctions (for training), should correspond to the number of outputs of the model
  val_function: [ CE, CE, CE, CE] # List of lossfunctions (for val/testing), should correspond to the number of outputs of the model
  weight: [1.0, 0.4, 0.05, 0.05]  # Weighting the different lossfunctions

###### Pytoch Lightning Trainer ######
pl_trainer:                   # parameters for the pytorch lightning trainer
  accelerator: 'gpu'          # train on GPU
  devices: -1                 # using all available GPUs
  max_epochs: ${epochs}       # parsing the number of epochs which is defined as a hyperparameter
  precision: 16-mixed         # using Mixed Precision
  benchmark: True             # using benchmark for faster training
  deterministic: False        # deterministic does not work because of not deterministc CrossEntropyLoss Error - use "warn" instead
  #enable_checkpointing: True  # Enable/Disable Checkpointing
  enable_checkpointing: ${checkpointing.enable}  # Enable/Disable Checkpointing

###### Model ######
model:
  name: ???                   # Name of the Model is needed for appropriate logging
  model:
    _target_: ???             # Path to the actual pytorch model

###### Metric ######
metric:
  name: ???                   # Name of the metric to optimize - is needed for logging and checkpointing
  train_metric: False         # If also a train metric is wanted (in addition to a validation metric)
  metric_per_img: False       # If True metric is computed for each image and averaged over all images
  metric_global: True         # If True metric is updated in each step and computed once at the end of the epoch
  metrics: ???                # List of torchmetrics

###### Dataset ######
dataset:
  root: ???
  name: ???                   # Name of the Dataset is needed for appropriate logging
  segmentation_type: ???
  num_classes: ???            # Needed since this makes a lot of stuff much easier
  ignore_index: 255           # Ignore index of the dataset if is used
  class_weights:     # Weighting of classes e.g. for the loss function
  class_labels: ???           # Class names, is needed because it makes some things easier and more comfortable
  img_folder: ???
  label_folder: ???
  img_folder_val: ???
  label_folder_val: ???
  img_folder_test: Null
  label_folder_test: Null
  dtype: ".png"
  dtype_mask: ".png"
  img_prefix: ""
  img_postfix: ""
  label_prefix: ""
  label_postfix: ""


###### Data-Augmentations ######
# Not all the parameters are needed and required dependent on which augmentation pipeline is used
augmentation:
  cfg:
    scale_limit: [-0.5, 1.0]  # Define the scale limits if scaling is used - albumentations definition 0 means no scaling
    crop_size: [512, 1024]    # Crop/patch size, used for: cropping operations; patch-wise inference; sampling dataset
    mean: [ 0.485, 0.456, 0.406 ]     # mean for normalization
    std: [ 0.229, 0.224, 0.225 ]      # std for normalization
    pad_size: ${augmentation.cfg.crop_size}   # Size for Padding, used for padding operations
    pad_mode: 0               # Mode for Padding: cv2.BORDER_CONSTANT, cv2.BORDER_REPLICATE, cv2.BORDER_REFLECT, cv2.BORDER_WRAP, cv2.BORDER_REFLECT_101
    pad_val: 0                # Value to pad the image with if padding is used
    pad_mask: ${dataset.ignore_index} # Value to pad the mask with if padding is used
    N: 3                      # Needed when using Randaugment, defines how many operations are used
    M: 3                      # Needed when using Randaugment, defines the magnitude of the operations

###### Test Time Augmentation ######
tta:
  hflip: False                 # If horizontal flipping should be used during testing
  vflip: False                # If vertical flipping should be used during testing
  resize: null
  scales: [1]     # Which scales should be used during testing: [1] means no scaling is used
  patchwise: False         # Use patchwise inference during: validation, testing and inference
  patch_size: ${augmentation.cfg.crop_size}   # Which patch-size to use when use_patching is True
  patch_overlap: 0.5          # Overlap between Patches

###### Logging ######
logging:
  name: "run"                 # To give custom names (as prefix) to the experiments
  logdir: logs/               # Logdir
  output_dir: ${hydra:runtime.output_dir}     # Output dir, determined by hydra
  progressbar: True # True | False
  num_example_predictions: 2        # Number of example predictions which are logged during validation
checkpointing:
    enable: True
    mode: max #min | max
    save_last: True #True | False
    weights_only: False #True | False

###### Datamodule ######
datamodule:
  _target_: src.datasets.DataModules.BaseDataModule   # Base Data Module
  #dataset: ${dataset.dataset}       # Parsing the Dataset defined in the dataset config
  dataset: ${training_scheme}       # Parsing the Dataset together with training_scheme
  batch_size: ${batch_size}         # Parsing all needed experiment parameter
  val_batch_size: ${val_batch_size}
  test_batch_size: ${test_batch_size}
  num_workers: ${num_workers}
  segmentation_type: ${dataset.segmentation_type}
  augmentations: ${augmentation}    # Parsing the Data augmentation, defined in the augmentation config

###### Checkpointing ######
ModelCheckpoint:
  _target_: src.callbacks.callbacks.customModelCheckpoint   # Custom checkpoint Callback with a few modifications
  monitor: "metric/${metric.name}"  # Name of the metric during logging
  mode: ${checkpointing.mode}                       # min or max: should be metric me maximised or minimized
  filename: 'best_epoch_{epoch}__${metric.name}_{metric/${metric.name}:.4f}'
  auto_insert_metric_name: False    # Needs to be false for better naming of checkpoint
  save_last: ${checkpointing.save_last}                  # If the last checkpoint should be saved too
  save_weights_only:  ${checkpointing.weights_only}           # If only state dict should be saved - if True not possible to continue training

###### Hydra ######
hydra:
  run:
    dir: ${logging.logdir}/${dataset.name}/${model.name}/${logging.name}__${path_formatter:${hydra.job.override_dirname}}/${fold_formatter:${fold}}/${now:%Y-%m-%d_%H-%M-%S}
    # Example Dir: /.../Semantic_Segmentation/logs/Cityscapes/hrnet/baseline__lossfunction_CE/2022-02-14_15-42-43/<ouputs>
    # using path_formatter with is defined in training.py to resolve problems which may occur with characters like [,],",or ',' in paths
  sweep:
    dir: multi_run_${hydra.run.dir}
    subdir: ${hydra.job.num}
  job_logging:
    handlers:
      file:
        filename: ${hydra.runtime.output_dir}/${hydra.job.name}.log
  job:
    config:
      override_dirname:
        kv_sep: "_"           # do not use "=" to prevent problems when parsing paths
        item_sep: "__"
        exclude_keys:         # excluding some key from ${hydra.job.override_dirname}
          - model             # already used in the path
          - dataset           # already used in the path
          - fold              # already used in path
          - environment       # no needed information for the experiments
          - finetune_from     # to long
          - continue_from     # to long
          - logging.name      # already used in the path
          - logging.logdir    # no needed information for the experiments
          - pl_trainer.enable_checkpointing   # no needed information for the experiments